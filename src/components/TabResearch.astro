---
import { getCollection } from 'astro:content';

const allResearch = await getCollection('research');
const articles = allResearch
  .sort((a, b) => (a.data.order ?? 99) - (b.data.order ?? 99))
  .map(entry => entry.data);

const tagColors: Record<string, string> = {
  'Ransomware': 'tag-red', 'BYOVD': 'tag-amber', 'Defense Evasion': 'tag-amber',
  'Cross-Platform': 'tag-cyan', 'LockBit': 'tag-red', 'APT Crossover': 'tag-purple',
  'DLL Sideloading': 'tag-amber', 'APT': 'tag-purple', 'China-Nexus': 'tag-purple',
  'Espionage': 'tag-purple', 'Taiwan': 'tag-cyan', 'RAT': 'tag-red',
  'Social Engineering': 'tag-amber', 'Red Team Tools': 'tag-amber',
  'EDR Evasion': 'tag-red', 'WFP': 'tag-cyan', 'GPO Abuse': 'tag-amber', 'Safe Mode': 'tag-amber',
};

const gradients = [
  'from-red-500/30 via-orange-500/20 to-yellow-500/10',
  'from-violet-500/30 via-purple-500/20 to-fuchsia-500/10',
  'from-red-600/30 via-rose-500/20 to-pink-500/10',
  'from-blue-500/30 via-indigo-500/20 to-violet-500/10',
  'from-amber-500/30 via-orange-500/20 to-red-500/10',
  'from-emerald-500/30 via-teal-500/20 to-cyan-500/10',
  'from-rose-500/30 via-red-500/20 to-orange-500/10',
  'from-cyan-500/30 via-blue-500/20 to-indigo-500/10',
];

const topicIcons: Record<string, string> = {
  'Ransomware': `<svg class="w-10 h-10" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/></svg>`,
  'APT': `<svg class="w-10 h-10" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5a17.92 17.92 0 01-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418"/></svg>`,
  'Red Team Tools': `<svg class="w-10 h-10" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.249-8.25-3.286zm0 13.036h.008v.008H12v-.008z"/></svg>`,
  'RAT': `<svg class="w-10 h-10" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75c1.148 0 2.278.08 3.383.237 1.037.146 1.866.966 1.866 2.013 0 3.728-2.35 6.75-5.25 6.75S6.75 18.728 6.75 15c0-1.046.83-1.867 1.866-2.013A24.204 24.204 0 0112 12.75zm0 0c2.883 0 5.647.508 8.207 1.44a23.91 23.91 0 01-1.152 6.06M12 12.75c-2.883 0-5.647.508-8.208 1.44.125 2.104.52 4.136 1.153 6.06M12 12.75a2.25 2.25 0 002.248-2.354M12 12.75a2.25 2.25 0 01-2.248-2.354M12 8.25c.995 0 1.971-.08 2.922-.236.403-.066.74-.358.795-.762a3.778 3.778 0 00-.399-2.25M12 8.25c-.995 0-1.97-.08-2.922-.236-.402-.066-.74-.358-.795-.762a3.734 3.734 0 01.4-2.253M12 8.25a2.25 2.25 0 00-2.248 2.146M12 8.25a2.25 2.25 0 012.248 2.146M8.683 5a6.032 6.032 0 01-1.155-1.002c.07-.63.27-1.222.574-1.747m.581 2.749A3.75 3.75 0 0112 3.75a3.75 3.75 0 013.317 1.25m0 0a6.02 6.02 0 011.155-1.002 4.005 4.005 0 00-.574-1.747"/></svg>`,
};

const getIcon = (tags: string[]) => {
  for (const tag of tags) {
    if (topicIcons[tag]) return topicIcons[tag];
  }
  return topicIcons['Ransomware'];
};

// Large modal icons
const topicIconsLg: Record<string, string> = {
  'Ransomware': `<svg class="w-16 h-16" fill="none" stroke="currentColor" stroke-width="0.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/></svg>`,
  'APT': `<svg class="w-16 h-16" fill="none" stroke="currentColor" stroke-width="0.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3"/></svg>`,
  'Red Team Tools': `<svg class="w-16 h-16" fill="none" stroke="currentColor" stroke-width="0.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.249-8.25-3.286zm0 13.036h.008v.008H12v-.008z"/></svg>`,
  'RAT': `<svg class="w-16 h-16" fill="none" stroke="currentColor" stroke-width="0.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75c1.148 0 2.278.08 3.383.237 1.037.146 1.866.966 1.866 2.013 0 3.728-2.35 6.75-5.25 6.75S6.75 18.728 6.75 15c0-1.046.83-1.867 1.866-2.013A24.204 24.204 0 0112 12.75z"/></svg>`,
};

const getIconLg = (tags: string[]) => {
  for (const tag of tags) {
    if (topicIconsLg[tag]) return topicIconsLg[tag];
  }
  return topicIconsLg['Ransomware'];
};

const categories = ['All', 'Ransomware', 'APT', 'Tools & RAT', 'Microstories'];

// Pre-compute related articles (by shared tags) for each article
const articlesWithRelated = articles.map((article, idx) => {
  const related = articles
    .map((other, otherIdx) => {
      if (otherIdx === idx) return null;
      const shared = article.tags.filter(t => other.tags.includes(t));
      return shared.length > 0 ? { title: other.title, url: other.url, sharedTags: shared.length, idx: otherIdx } : null;
    })
    .filter(Boolean)
    .sort((a, b) => (b?.sharedTags || 0) - (a?.sharedTags || 0))
    .slice(0, 3);
  return { ...article, related };
});
---

<div class="content-card">
  <h2 class="section-title">Published Research</h2>
  <p class="section-subtitle">
    Threat research published on Trend Micro's research blog and X/Twitter microstories.
    <span class="text-text-muted">Much of my work is internal threat intelligence under TLP:AMBER.</span>
  </p>

  <!-- Research stats bar -->
  <div class="flex items-center gap-4 mb-5 text-[10px] font-mono text-text-muted">
    <span class="flex items-center gap-1.5">
      <span class="w-1.5 h-1.5 rounded-full bg-accent-danger"></span>
      <span><span class="text-text-secondary font-semibold">{articles.filter(a => a.type !== 'microstory').length}</span> Blog Articles</span>
    </span>
    <span class="flex items-center gap-1.5">
      <span class="w-1.5 h-1.5 rounded-full bg-sky-400"></span>
      <span><span class="text-text-secondary font-semibold">{articles.filter(a => a.type === 'microstory').length}</span> Microstories</span>
    </span>
    <span class="flex items-center gap-1.5">
      <span class="w-1.5 h-1.5 rounded-full bg-accent-primary"></span>
      <span><span class="text-text-secondary font-semibold">{articles.length}</span> Total</span>
    </span>
  </div>

  <!-- Search bar -->
  <div class="relative mb-4">
    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-text-muted pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
    </svg>
    <input
      type="text"
      id="research-search"
      placeholder="Search articles, tags, topics..."
      class="w-full pl-10 pr-20 py-2.5 rounded-xl bg-bg-surface/60 border border-white/[0.06] text-text-primary text-sm placeholder:text-text-muted/50 focus:outline-none focus:border-accent-primary/30 focus:bg-bg-surface transition-all font-mono"
    />
    <span id="search-count" class="absolute right-12 top-1/2 -translate-y-1/2 text-[10px] font-mono text-text-muted hidden"></span>
    <kbd class="absolute right-3 top-1/2 -translate-y-1/2 text-[9px] font-mono text-text-muted/40 bg-bg-surface/80 px-1.5 py-0.5 rounded border border-white/[0.06] pointer-events-none" id="search-kbd">/</kbd>
  </div>

  <!-- Filter bar -->
  <div class="flex gap-2 mb-6 overflow-x-auto pb-1" id="research-filters">
    {categories.map((cat, i) => (
      <button
        class={`tag cursor-pointer transition-all ${i === 0 ? 'bg-accent-primary/15 text-accent-primary border-accent-primary/25' : 'text-text-muted border-white/10 hover:text-text-primary hover:border-white/20'}`}
        data-filter={cat}
      >
        {cat}
      </button>
    ))}
  </div>

  <!-- Article grid -->
  <div class="grid sm:grid-cols-2 gap-4" id="research-list">
    {articlesWithRelated.map((article, idx) => (
      <div
        class="research-card group cursor-pointer"
        data-tags={article.tags.join(',')}
        data-url={article.url}
        data-title={article.title}
        data-description={article.description}
        data-summary={article.summary || article.description}
        data-date={article.date}
        data-source={article.source || 'Trend Micro Research Blog'}
        data-type={article.type || 'blog'}
        data-gradient={gradients[idx % gradients.length]}
        data-all-tags={JSON.stringify(article.tags)}
        data-related={JSON.stringify(article.related)}
        data-search-text={`${article.title} ${article.description} ${article.tags.join(' ')} ${article.summary || ''}`}
      >
        <!-- Gradient thumbnail -->
        <div class={`relative h-36 bg-gradient-to-br ${gradients[idx % gradients.length]} overflow-hidden`}>
          <div class="absolute inset-0" style="background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 20px 20px;"></div>
          <div class="research-thumb absolute inset-0 flex items-center justify-center text-white/20">
            <Fragment set:html={getIcon(article.tags)} />
          </div>
          <div class="absolute top-3 right-3 flex gap-1.5">
            {(article.type === 'microstory') && (
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md bg-sky-500/20 backdrop-blur-sm text-[10px] font-mono text-sky-300 border border-sky-400/20">
                <svg class="w-2.5 h-2.5" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                Thread
              </span>
            )}
            <span class="inline-flex items-center px-2 py-0.5 rounded-md bg-black/40 backdrop-blur-sm text-[10px] font-mono text-text-secondary">
              {article.date}
            </span>
          </div>
          <div class="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
            <div class="w-8 h-8 rounded-lg bg-accent-primary/90 flex items-center justify-center">
              <svg class="w-4 h-4 text-bg-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Card content -->
        <div class="p-4">
          <h3 class="text-text-primary text-sm font-semibold group-hover:text-accent-primary transition-colors mb-2 leading-snug line-clamp-2">
            {article.title}
          </h3>
          <p class="text-text-muted text-xs leading-relaxed mb-3 line-clamp-2">
            {article.description}
          </p>
          <div class="flex flex-wrap gap-1">
            {article.tags.slice(0, 3).map(tag => (
              <span class={`${tagColors[tag] || 'tag-green'} !text-[8px]`}>{tag}</span>
            ))}
          </div>
        </div>
      </div>
    ))}
  </div>

  <!-- No results message -->
  <div id="no-results" class="hidden text-center py-12">
    <svg class="w-12 h-12 text-text-muted/30 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
    </svg>
    <p class="text-text-muted text-sm">No articles match your search</p>
    <button id="clear-search" class="mt-2 text-accent-primary text-xs font-mono hover:underline">Clear search</button>
  </div>
</div>

<!-- Article Detail Modal -->
<div id="article-modal" class="hidden">
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-content !max-w-2xl">
      <!-- Gradient hero header -->
      <div id="modal-hero" class="relative h-48 bg-gradient-to-br from-red-500/30 via-orange-500/20 to-yellow-500/10 overflow-hidden">
        <div class="absolute inset-0" style="background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 24px 24px;"></div>
        <div class="absolute inset-0 flex items-center justify-center text-white/15" id="modal-icon"></div>
        <!-- Close button -->
        <button id="modal-close" class="absolute top-4 right-4 w-9 h-9 rounded-xl bg-black/40 backdrop-blur-sm border border-white/10 flex items-center justify-center text-white/60 hover:text-white hover:border-white/30 transition-all z-10">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <!-- Role + Date badges -->
        <div class="absolute top-4 left-4 flex gap-2" id="modal-badges"></div>
        <!-- Bottom gradient fade -->
        <div class="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-bg-card to-transparent"></div>
      </div>

      <!-- Content body -->
      <div class="p-6 -mt-8 relative overflow-y-auto">
        <h2 class="text-text-primary text-xl font-bold leading-tight mb-3 tracking-tight" id="modal-title"></h2>
        <p class="text-text-secondary text-sm leading-relaxed mb-5" id="modal-description"></p>

        <!-- Tags -->
        <div class="flex flex-wrap gap-1.5 mb-6" id="modal-tags"></div>

        <!-- Related Research -->
        <div id="modal-related" class="hidden mb-6">
          <div class="border-t border-white/[0.06] mb-4 pt-4">
            <div class="flex items-center gap-2 mb-3">
              <svg class="w-3.5 h-3.5 text-accent-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m9.86-2.813a4.5 4.5 0 00-6.364-6.364L4.5 8.25a4.5 4.5 0 006.364 6.364l4.5-4.5z"/>
              </svg>
              <span class="text-text-secondary text-xs font-semibold">Related Research</span>
            </div>
            <div id="modal-related-list" class="space-y-2"></div>
          </div>
        </div>

        <!-- Divider -->
        <div class="border-t border-white/[0.06] mb-5"></div>

        <!-- Action buttons -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <a id="modal-read-btn" href="#" target="_blank" rel="noopener"
              class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-accent-primary text-bg-primary font-semibold text-sm transition-all hover:shadow-[0_0_30px_-5px_rgba(0,223,162,0.4)] hover:scale-[1.02]">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
              </svg>
              Read Full Article
            </a>
            <button id="modal-close-btn" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl bg-bg-surface border border-white/[0.06] text-text-muted text-sm font-medium hover:text-text-primary hover:border-white/10 transition-all">
              Close
            </button>
          </div>
          <!-- Prev/Next navigation -->
          <div class="flex items-center gap-1.5">
            <button id="modal-prev-btn" class="w-8 h-8 rounded-lg bg-bg-surface border border-white/[0.06] flex items-center justify-center text-text-muted hover:text-accent-primary hover:border-accent-primary/20 transition-all disabled:opacity-30 disabled:cursor-not-allowed" title="Previous (←)">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 19.5L8.25 12l7.5-7.5"/></svg>
            </button>
            <span id="modal-counter" class="text-text-muted text-[10px] font-mono min-w-[3rem] text-center"></span>
            <button id="modal-next-btn" class="w-8 h-8 rounded-lg bg-bg-surface border border-white/[0.06] flex items-center justify-center text-text-muted hover:text-accent-primary hover:border-accent-primary/20 transition-all disabled:opacity-30 disabled:cursor-not-allowed" title="Next (→)">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.25 4.5l7.5 7.5-7.5 7.5"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Tag color map for modal
  const tagColorMap: Record<string, string> = {
    'Ransomware': 'tag-red', 'BYOVD': 'tag-amber', 'Defense Evasion': 'tag-amber',
    'Cross-Platform': 'tag-cyan', 'LockBit': 'tag-red', 'APT Crossover': 'tag-purple',
    'DLL Sideloading': 'tag-amber', 'APT': 'tag-purple', 'China-Nexus': 'tag-purple',
    'Espionage': 'tag-purple', 'Taiwan': 'tag-cyan', 'RAT': 'tag-red',
    'Social Engineering': 'tag-amber', 'Red Team Tools': 'tag-amber',
    'EDR Evasion': 'tag-red', 'WFP': 'tag-cyan', 'GPO Abuse': 'tag-amber', 'Safe Mode': 'tag-amber',
  };

  // Icon SVGs for modal (large)
  const iconMap: Record<string, string> = {
    'Ransomware': `<svg class="w-20 h-20" fill="none" stroke="currentColor" stroke-width="0.7" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/></svg>`,
    'APT': `<svg class="w-20 h-20" fill="none" stroke="currentColor" stroke-width="0.7" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3"/></svg>`,
    'Red Team Tools': `<svg class="w-20 h-20" fill="none" stroke="currentColor" stroke-width="0.7" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.249-8.25-3.286zm0 13.036h.008v.008H12v-.008z"/></svg>`,
    'RAT': `<svg class="w-20 h-20" fill="none" stroke="currentColor" stroke-width="0.7" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75c1.148 0 2.278.08 3.383.237 1.037.146 1.866.966 1.866 2.013 0 3.728-2.35 6.75-5.25 6.75S6.75 18.728 6.75 15c0-1.046.83-1.867 1.866-2.013A24.204 24.204 0 0112 12.75z"/></svg>`,
  };

  const getModalIcon = (tags: string[]): string => {
    for (const tag of tags) {
      if (iconMap[tag]) return iconMap[tag];
    }
    return iconMap['Ransomware'];
  };

  // Gradient classes for modal hero
  const gradientClasses = [
    'from-red-500/30 via-orange-500/20 to-yellow-500/10',
    'from-violet-500/30 via-purple-500/20 to-fuchsia-500/10',
    'from-red-600/30 via-rose-500/20 to-pink-500/10',
    'from-blue-500/30 via-indigo-500/20 to-violet-500/10',
    'from-amber-500/30 via-orange-500/20 to-red-500/10',
    'from-emerald-500/30 via-teal-500/20 to-cyan-500/10',
    'from-rose-500/30 via-red-500/20 to-orange-500/10',
    'from-cyan-500/30 via-blue-500/20 to-indigo-500/10',
  ];

  // Research filters
  const filterBtns = document.querySelectorAll('#research-filters button');
  const cards = document.querySelectorAll('#research-list .research-card');
  const searchInput = document.getElementById('research-search') as HTMLInputElement;
  const searchCount = document.getElementById('search-count')!;
  const noResults = document.getElementById('no-results')!;
  const clearSearchBtn = document.getElementById('clear-search');

  const categoryMap: Record<string, string[]> = {
    'All': [],
    'Ransomware': ['Ransomware'],
    'APT': ['APT', 'APT Crossover', 'China-Nexus', 'Espionage'],
    'Tools & RAT': ['Red Team Tools', 'EDR Evasion', 'RAT', 'Social Engineering'],
    'Microstories': [], // Special filter handled by type
  };

  let activeFilter = 'All';
  let searchQuery = '';

  const applyFilters = () => {
    let visibleCount = 0;
    cards.forEach(card => {
      const el = card as HTMLElement;
      const tags = (el.dataset.tags || '').split(',');
      const searchText = (el.dataset.searchText || '').toLowerCase();
      const type = el.dataset.type || 'blog';

      let matchesFilter = true;
      if (activeFilter === 'Microstories') {
        matchesFilter = type === 'microstory';
      } else if (activeFilter !== 'All') {
        const matchTags = categoryMap[activeFilter] || [];
        matchesFilter = matchTags.some(t => tags.includes(t));
      }

      let matchesSearch = true;
      if (searchQuery) {
        matchesSearch = searchText.includes(searchQuery.toLowerCase());
      }

      const visible = matchesFilter && matchesSearch;
      el.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });

    // Update search count
    if (searchQuery) {
      searchCount.textContent = `${visibleCount} found`;
      searchCount.classList.remove('hidden');
    } else {
      searchCount.classList.add('hidden');
    }

    // Show/hide no results
    noResults.classList.toggle('hidden', visibleCount > 0);
  };

  // Filter buttons
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      activeFilter = (btn as HTMLElement).dataset.filter || 'All';
      filterBtns.forEach(b => {
        b.className = b.className
          .replace(/bg-accent-primary\/15 text-accent-primary border-accent-primary\/25/g,
            'text-text-muted border-white/10 hover:text-text-primary hover:border-white/20');
      });
      btn.className = btn.className
        .replace(/text-text-muted border-white\/10 hover:text-text-primary hover:border-white\/20/g,
          'bg-accent-primary/15 text-accent-primary border-accent-primary/25');
      applyFilters();
    });
  });

  // Search input
  let searchTimeout: ReturnType<typeof setTimeout>;
  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchQuery = searchInput.value.trim();
      applyFilters();
    }, 150);
  });

  // Keyboard shortcut: "/" to focus search (like GitHub)
  const searchKbd = document.getElementById('search-kbd');
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && !modal.classList.contains('hidden') === false) {
      const active = document.activeElement;
      if (active?.tagName !== 'INPUT' && active?.tagName !== 'TEXTAREA') {
        e.preventDefault();
        searchInput.focus();
      }
    }
  });
  searchInput.addEventListener('focus', () => searchKbd && (searchKbd.style.display = 'none'));
  searchInput.addEventListener('blur', () => {
    if (!searchInput.value) searchKbd && (searchKbd.style.display = '');
  });

  // Clear search
  clearSearchBtn?.addEventListener('click', () => {
    searchInput.value = '';
    searchQuery = '';
    applyFilters();
    searchInput.focus();
  });

  // Modal elements
  const modal = document.getElementById('article-modal')!;
  const overlay = document.getElementById('modal-overlay')!;
  const modalHero = document.getElementById('modal-hero')!;
  const modalIcon = document.getElementById('modal-icon')!;
  const modalBadges = document.getElementById('modal-badges')!;
  const modalTitle = document.getElementById('modal-title')!;
  const modalDescription = document.getElementById('modal-description')!;
  const modalTags = document.getElementById('modal-tags')!;
  const modalReadBtn = document.getElementById('modal-read-btn') as HTMLAnchorElement;
  const modalClose = document.getElementById('modal-close')!;
  const modalCloseBtn = document.getElementById('modal-close-btn')!;
  const modalPrevBtn = document.getElementById('modal-prev-btn') as HTMLButtonElement;
  const modalNextBtn = document.getElementById('modal-next-btn') as HTMLButtonElement;
  const modalCounter = document.getElementById('modal-counter')!;
  const modalRelated = document.getElementById('modal-related')!;
  const modalRelatedList = document.getElementById('modal-related-list')!;

  // Open modal on card click
  cards.forEach((card, idx) => {
    card.addEventListener('click', () => {
      currentCardIndex = idx;
      const el = card as HTMLElement;
      const url = el.dataset.url || '';
      const title = el.dataset.title || '';
      const summary = el.dataset.summary || el.dataset.description || '';
      const date = el.dataset.date || '';
      const source = el.dataset.source || 'Trend Micro Research Blog';
      const contentType = el.dataset.type || 'blog';
      const tags: string[] = JSON.parse(el.dataset.allTags || '[]');
      const gradient = gradientClasses[idx % gradientClasses.length];
      const related: Array<{title: string; url: string; sharedTags: number; idx: number}> = JSON.parse(el.dataset.related || '[]');

      // Update hero gradient
      modalHero.className = `relative h-48 bg-gradient-to-br ${gradient} overflow-hidden`;

      // Update icon
      modalIcon.innerHTML = getModalIcon(tags);

      // Update badges
      let badgesHtml = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-black/40 backdrop-blur-sm text-[11px] font-mono text-accent-primary border border-accent-primary/20"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>${source}</span>`;
      badgesHtml += `<span class="inline-flex items-center px-2.5 py-1 rounded-lg bg-black/40 backdrop-blur-sm text-[11px] font-mono text-text-secondary">${date}</span>`;
      modalBadges.innerHTML = badgesHtml;

      // Update content
      modalTitle.textContent = title;
      modalDescription.textContent = summary;
      modalReadBtn.href = url;
      // Update button label based on content type
      const isMicrostory = contentType === 'microstory';
      modalReadBtn.innerHTML = isMicrostory
        ? `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>View Thread`
        : `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>Read Full Article`;

      // Update tags
      modalTags.innerHTML = tags.map(tag =>
        `<span class="${tagColorMap[tag] || 'tag-green'}">${tag}</span>`
      ).join('');

      // Update related research
      if (related && related.length > 0) {
        modalRelated.classList.remove('hidden');
        modalRelatedList.innerHTML = related.map(r =>
          `<a href="${r.url}" target="_blank" rel="noopener" class="flex items-center gap-3 p-2.5 rounded-lg bg-bg-surface/40 border border-white/[0.04] hover:border-accent-primary/15 hover:bg-bg-hover/60 transition-all group/related">
            <svg class="w-3.5 h-3.5 text-text-muted group-hover/related:text-accent-primary shrink-0 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
            <span class="text-text-secondary text-xs group-hover/related:text-text-primary transition-colors truncate">${r.title}</span>
            <svg class="w-3 h-3 text-text-muted/40 shrink-0 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25"/></svg>
          </a>`
        ).join('');
      } else {
        modalRelated.classList.add('hidden');
      }

      // Update navigation counter
      const visible = getVisibleCards();
      const pos = visible.indexOf(idx);
      modalCounter.textContent = `${pos + 1} / ${visible.length}`;
      modalPrevBtn.disabled = pos <= 0;
      modalNextBtn.disabled = pos >= visible.length - 1;

      // Show modal
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    });
  });

  // Prev/Next button handlers
  modalPrevBtn.addEventListener('click', () => {
    const visible = getVisibleCards();
    const currentPos = visible.indexOf(currentCardIndex);
    if (currentPos > 0) openCardByIndex(visible[currentPos - 1]);
  });

  modalNextBtn.addEventListener('click', () => {
    const visible = getVisibleCards();
    const currentPos = visible.indexOf(currentCardIndex);
    if (currentPos < visible.length - 1) openCardByIndex(visible[currentPos + 1]);
  });

  // Track current article index for keyboard navigation
  let currentCardIndex = -1;
  const allCards = Array.from(cards);

  const openCardByIndex = (idx: number) => {
    if (idx < 0 || idx >= allCards.length) return;
    const card = allCards[idx] as HTMLElement;
    if (card.style.display === 'none') return;
    currentCardIndex = idx;
    card.click();
  };

  const getVisibleCards = (): number[] => {
    return allCards.reduce<number[]>((acc, card, idx) => {
      if ((card as HTMLElement).style.display !== 'none') acc.push(idx);
      return acc;
    }, []);
  };

  // Close modal
  const closeModal = () => {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
    currentCardIndex = -1;
  };

  modalClose.addEventListener('click', closeModal);
  modalCloseBtn.addEventListener('click', closeModal);
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
    if (!modal.classList.contains('hidden')) {
      const visible = getVisibleCards();
      const currentPos = visible.indexOf(currentCardIndex);
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault();
        const nextPos = currentPos + 1;
        if (nextPos < visible.length) openCardByIndex(visible[nextPos]);
      }
      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        const prevPos = currentPos - 1;
        if (prevPos >= 0) openCardByIndex(visible[prevPos]);
      }
    }
  });
</script>
