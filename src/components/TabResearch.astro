---
import { getCollection } from 'astro:content';

const allResearch = await getCollection('research');
const articles = allResearch
  .sort((a, b) => (a.data.order ?? 99) - (b.data.order ?? 99))
  .map(entry => entry.data);

const tagColors: Record<string, string> = {
  'Ransomware': 'tag-red', 'BYOVD': 'tag-amber', 'Defense Evasion': 'tag-amber',
  'Cross-Platform': 'tag-cyan', 'LockBit': 'tag-red', 'APT Crossover': 'tag-purple',
  'DLL Sideloading': 'tag-amber', 'APT': 'tag-purple', 'China-Nexus': 'tag-purple',
  'Espionage': 'tag-purple', 'Taiwan': 'tag-cyan', 'RAT': 'tag-red',
  'Social Engineering': 'tag-amber', 'Red Team Tools': 'tag-amber',
  'EDR Evasion': 'tag-red', 'WFP': 'tag-cyan', 'GPO Abuse': 'tag-amber', 'Safe Mode': 'tag-amber',
};

// Each article gets a unique gradient for its visual thumbnail
const gradients = [
  'from-red-500/30 via-orange-500/20 to-yellow-500/10',
  'from-violet-500/30 via-purple-500/20 to-fuchsia-500/10',
  'from-red-600/30 via-rose-500/20 to-pink-500/10',
  'from-blue-500/30 via-indigo-500/20 to-violet-500/10',
  'from-amber-500/30 via-orange-500/20 to-red-500/10',
  'from-emerald-500/30 via-teal-500/20 to-cyan-500/10',
  'from-rose-500/30 via-red-500/20 to-orange-500/10',
  'from-cyan-500/30 via-blue-500/20 to-indigo-500/10',
];

// Topic icons (SVG) for each article type
const topicIcons: Record<string, string> = {
  'Ransomware': `<svg class="w-10 h-10" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/></svg>`,
  'APT': `<svg class="w-10 h-10" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5a17.92 17.92 0 01-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418"/></svg>`,
  'Red Team Tools': `<svg class="w-10 h-10" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.249-8.25-3.286zm0 13.036h.008v.008H12v-.008z"/></svg>`,
  'RAT': `<svg class="w-10 h-10" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75c1.148 0 2.278.08 3.383.237 1.037.146 1.866.966 1.866 2.013 0 3.728-2.35 6.75-5.25 6.75S6.75 18.728 6.75 15c0-1.046.83-1.867 1.866-2.013A24.204 24.204 0 0112 12.75zm0 0c2.883 0 5.647.508 8.207 1.44a23.91 23.91 0 01-1.152 6.06M12 12.75c-2.883 0-5.647.508-8.208 1.44.125 2.104.52 4.136 1.153 6.06M12 12.75a2.25 2.25 0 002.248-2.354M12 12.75a2.25 2.25 0 01-2.248-2.354M12 8.25c.995 0 1.971-.08 2.922-.236.403-.066.74-.358.795-.762a3.778 3.778 0 00-.399-2.25M12 8.25c-.995 0-1.97-.08-2.922-.236-.402-.066-.74-.358-.795-.762a3.734 3.734 0 01.4-2.253M12 8.25a2.25 2.25 0 00-2.248 2.146M12 8.25a2.25 2.25 0 012.248 2.146M8.683 5a6.032 6.032 0 01-1.155-1.002c.07-.63.27-1.222.574-1.747m.581 2.749A3.75 3.75 0 0112 3.75a3.75 3.75 0 013.317 1.25m0 0a6.02 6.02 0 011.155-1.002 4.005 4.005 0 00-.574-1.747"/></svg>`,
};

const getIcon = (tags: string[]) => {
  for (const tag of tags) {
    if (topicIcons[tag]) return topicIcons[tag];
  }
  return topicIcons['Ransomware'];
};

const categories = ['All', 'Ransomware', 'APT', 'Tools & RAT'];
---

<div class="content-card">
  <h2 class="section-title">Published Research</h2>
  <p class="section-subtitle">
    Threat research published on Trend Micro's research blog.
    <span class="text-text-muted">Much of my work is internal threat intelligence under TLP:AMBER.</span>
  </p>

  <!-- Filter bar -->
  <div class="flex gap-2 mb-6 overflow-x-auto pb-1" id="research-filters">
    {categories.map((cat, i) => (
      <button
        class={`tag cursor-pointer transition-all ${i === 0 ? 'bg-accent-primary/15 text-accent-primary border-accent-primary/25' : 'text-text-muted border-white/10 hover:text-text-primary hover:border-white/20'}`}
        data-filter={cat}
      >
        {cat}
      </button>
    ))}
  </div>

  <!-- Article grid -->
  <div class="grid sm:grid-cols-2 gap-4" id="research-list">
    {articles.map((article, idx) => (
      <div
        class="research-card group"
        data-tags={article.tags.join(',')}
        data-url={article.url}
        data-title={article.title}
      >
        <!-- Gradient thumbnail -->
        <div class={`relative h-36 bg-gradient-to-br ${gradients[idx % gradients.length]} overflow-hidden`}>
          <!-- Grid overlay -->
          <div class="absolute inset-0" style="background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 20px 20px;"></div>
          <!-- Topic icon -->
          <div class="research-thumb absolute inset-0 flex items-center justify-center text-white/20">
            <Fragment set:html={getIcon(article.tags)} />
          </div>
          <!-- Role badge -->
          {(article.role === 'Lead Author' || article.role === 'Co-Lead') && (
            <div class="absolute top-3 left-3">
              <span class="inline-flex items-center px-2 py-0.5 rounded-md bg-black/40 backdrop-blur-sm text-[10px] font-mono font-semibold text-accent-primary border border-accent-primary/20">
                {article.role === 'Lead Author' ? 'LEAD' : 'CO-LEAD'}
              </span>
            </div>
          )}
          <!-- Date -->
          <div class="absolute top-3 right-3">
            <span class="inline-flex items-center px-2 py-0.5 rounded-md bg-black/40 backdrop-blur-sm text-[10px] font-mono text-text-secondary">
              {article.date}
            </span>
          </div>
          <!-- External link indicator on hover -->
          <div class="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
            <div class="w-8 h-8 rounded-lg bg-accent-primary/90 flex items-center justify-center">
              <svg class="w-4 h-4 text-bg-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Card content -->
        <div class="p-4">
          <h3 class="text-text-primary text-sm font-semibold group-hover:text-accent-primary transition-colors mb-2 leading-snug line-clamp-2">
            {article.title}
          </h3>
          <p class="text-text-muted text-xs leading-relaxed mb-3 line-clamp-2">
            {article.description}
          </p>
          <div class="flex flex-wrap gap-1">
            {article.tags.slice(0, 3).map(tag => (
              <span class={`${tagColors[tag] || 'tag-green'} !text-[8px]`}>{tag}</span>
            ))}
          </div>
        </div>
      </div>
    ))}
  </div>
</div>

<!-- Article Modal -->
<div id="article-modal" class="hidden">
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-content">
      <!-- Modal header -->
      <div class="flex items-center justify-between p-4 border-b border-white/[0.06]">
        <h3 class="text-text-primary text-sm font-semibold truncate pr-4" id="modal-title">Article</h3>
        <div class="flex items-center gap-2 shrink-0">
          <a id="modal-external" href="#" target="_blank" rel="noopener"
            class="w-8 h-8 rounded-lg bg-bg-surface border border-white/[0.06] flex items-center justify-center text-text-muted hover:text-accent-primary hover:border-accent-primary/20 transition-colors"
            title="Open in new tab">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
            </svg>
          </a>
          <button id="modal-close"
            class="w-8 h-8 rounded-lg bg-bg-surface border border-white/[0.06] flex items-center justify-center text-text-muted hover:text-accent-danger hover:border-accent-danger/20 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
      <!-- Modal body (iframe) -->
      <div class="flex-1 overflow-hidden bg-white">
        <iframe id="modal-iframe" class="w-full h-full min-h-[60vh]" src="" frameborder="0" loading="lazy"></iframe>
      </div>
    </div>
  </div>
</div>

<script>
  // Research filters
  const filterBtns = document.querySelectorAll('#research-filters button');
  const cards = document.querySelectorAll('#research-list .research-card');

  const categoryMap: Record<string, string[]> = {
    'All': [],
    'Ransomware': ['Ransomware'],
    'APT': ['APT', 'APT Crossover', 'China-Nexus', 'Espionage'],
    'Tools & RAT': ['Red Team Tools', 'EDR Evasion', 'RAT', 'Social Engineering'],
  };

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const filter = (btn as HTMLElement).dataset.filter || 'All';

      filterBtns.forEach(b => {
        b.className = b.className
          .replace(/bg-accent-primary\/15 text-accent-primary border-accent-primary\/25/g,
            'text-text-muted border-white/10 hover:text-text-primary hover:border-white/20');
      });
      btn.className = btn.className
        .replace(/text-text-muted border-white\/10 hover:text-text-primary hover:border-white\/20/g,
          'bg-accent-primary/15 text-accent-primary border-accent-primary/25');

      const matchTags = categoryMap[filter] || [];
      cards.forEach(card => {
        const el = card as HTMLElement;
        if (filter === 'All') {
          el.style.display = '';
        } else {
          const tags = (el.dataset.tags || '').split(',');
          el.style.display = matchTags.some(t => tags.includes(t)) ? '' : 'none';
        }
      });
    });
  });

  // Modal functionality
  const modal = document.getElementById('article-modal')!;
  const overlay = document.getElementById('modal-overlay')!;
  const modalTitle = document.getElementById('modal-title')!;
  const modalIframe = document.getElementById('modal-iframe') as HTMLIFrameElement;
  const modalExternal = document.getElementById('modal-external') as HTMLAnchorElement;
  const modalClose = document.getElementById('modal-close')!;

  // Open modal on card click
  cards.forEach(card => {
    card.addEventListener('click', () => {
      const el = card as HTMLElement;
      const url = el.dataset.url || '';
      const title = el.dataset.title || '';

      modalTitle.textContent = title;
      modalIframe.src = url;
      modalExternal.href = url;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    });
  });

  // Close modal
  const closeModal = () => {
    modal.classList.add('hidden');
    modalIframe.src = '';
    document.body.style.overflow = '';
  };

  modalClose.addEventListener('click', closeModal);
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });
</script>
