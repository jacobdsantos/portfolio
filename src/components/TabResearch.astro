---
import { getCollection } from 'astro:content';

const allResearch = await getCollection('research');
const articles = allResearch
  .sort((a, b) => (a.data.order ?? 99) - (b.data.order ?? 99))
  .map(entry => entry.data);

const tagColors: Record<string, string> = {
  'Ransomware': 'tag-red',
  'BYOVD': 'tag-amber',
  'Defense Evasion': 'tag-amber',
  'Cross-Platform': 'tag-cyan',
  'LockBit': 'tag-red',
  'APT Crossover': 'tag-blue',
  'DLL Sideloading': 'tag-amber',
  'APT': 'tag-blue',
  'China-Nexus': 'tag-blue',
  'Espionage': 'tag-blue',
  'Taiwan': 'tag-cyan',
  'RAT': 'tag-red',
  'Social Engineering': 'tag-amber',
  'Red Team Tools': 'tag-amber',
  'EDR Evasion': 'tag-red',
  'WFP': 'tag-cyan',
  'GPO Abuse': 'tag-amber',
  'Safe Mode': 'tag-amber',
};

const categories = ['All', 'Ransomware', 'APT', 'Tools & RAT'];

const categoryMap: Record<string, string[]> = {
  'All': [],
  'Ransomware': ['Ransomware'],
  'APT': ['APT', 'APT Crossover', 'China-Nexus', 'Espionage'],
  'Tools & RAT': ['Red Team Tools', 'EDR Evasion', 'RAT', 'Social Engineering'],
};
---

<div class="content-card">
  <h2 class="section-title">Published Research</h2>
  <p class="text-text-secondary text-sm mb-6">
    Threat research published on Trend Micro's research blog.
    <span class="text-text-muted">Much of my work is internal threat intelligence under TLP:AMBER.</span>
  </p>

  <!-- Filter bar -->
  <div class="flex gap-2 mb-6 overflow-x-auto pb-1" id="research-filters">
    {categories.map((cat, i) => (
      <button
        class={`tag ${i === 0 ? 'bg-accent-primary/20 text-accent-primary border-accent-primary/30' : 'text-text-muted border-white/10 hover:text-text-primary hover:border-white/20'} cursor-pointer transition-all`}
        data-filter={cat}
      >
        {cat}
      </button>
    ))}
  </div>

  <!-- Article list -->
  <div class="space-y-3" id="research-list">
    {articles.map(article => (
      <a
        href={article.url}
        target="_blank"
        rel="noopener"
        class="card !p-4 group block"
        data-tags={article.tags.join(',')}
      >
        <div class="flex items-start justify-between gap-3">
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1.5">
              <span class="text-text-muted text-[10px] font-mono">{article.date}</span>
              {(article.role === 'Lead Author' || article.role === 'Co-Lead') && (
                <span class="tag-green !text-[8px] !px-1.5 !py-0">{article.role === 'Lead Author' ? 'Lead' : 'Co-Lead'}</span>
              )}
            </div>
            <h3 class="text-text-primary text-sm font-medium group-hover:text-accent-primary transition-colors mb-1.5 leading-snug">
              {article.title}
            </h3>
            <p class="text-text-muted text-xs leading-relaxed mb-2">
              {article.description}
            </p>
            <div class="flex flex-wrap gap-1">
              {article.tags.map(tag => (
                <span class={`${tagColors[tag] || 'tag-blue'} !text-[8px]`}>{tag}</span>
              ))}
            </div>
          </div>
          <div class="shrink-0 text-text-muted group-hover:text-accent-primary transition-colors mt-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 17L17 7M17 7H7M17 7v10" />
            </svg>
          </div>
        </div>
      </a>
    ))}
  </div>
</div>

<script>
  const filterBtns = document.querySelectorAll('#research-filters button');
  const articles = document.querySelectorAll('#research-list a');

  const categoryMap: Record<string, string[]> = {
    'All': [],
    'Ransomware': ['Ransomware'],
    'APT': ['APT', 'APT Crossover', 'China-Nexus', 'Espionage'],
    'Tools & RAT': ['Red Team Tools', 'EDR Evasion', 'RAT', 'Social Engineering'],
  };

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const filter = (btn as HTMLElement).dataset.filter || 'All';

      filterBtns.forEach(b => {
        b.className = b.className.replace(/bg-accent-primary\/20 text-accent-primary border-accent-primary\/30/g, 'text-text-muted border-white/10 hover:text-text-primary hover:border-white/20');
      });
      btn.className = btn.className.replace(/text-text-muted border-white\/10 hover:text-text-primary hover:border-white\/20/g, 'bg-accent-primary/20 text-accent-primary border-accent-primary/30');

      const matchTags = categoryMap[filter] || [];
      articles.forEach(article => {
        const el = article as HTMLElement;
        if (filter === 'All') {
          el.style.display = '';
        } else {
          const tags = (el.dataset.tags || '').split(',');
          const match = matchTags.some(t => tags.includes(t));
          el.style.display = match ? '' : 'none';
        }
      });
    });
  });
</script>
