---
import AppShell from '../../design-system/components/AppShell.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allResearch = await getCollection('research');
  return allResearch.map(entry => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const article = entry.data;

// Get all research for related items
const allResearch = await getCollection('research');
const related = allResearch
  .filter(other => other.id !== entry.id)
  .map(other => {
    const sharedTags = article.tags.filter(t => other.data.tags.includes(t));
    return { entry: other, sharedCount: sharedTags.length };
  })
  .filter(r => r.sharedCount > 0)
  .sort((a, b) => b.sharedCount - a.sharedCount)
  .slice(0, 4);

const tagColors: Record<string, string> = {
  'Ransomware': 'tag-red', 'BYOVD': 'tag-amber', 'Defense Evasion': 'tag-amber',
  'Cross-Platform': 'tag-cyan', 'LockBit': 'tag-red', 'APT Crossover': 'tag-purple',
  'DLL Sideloading': 'tag-amber', 'APT': 'tag-purple', 'China-Nexus': 'tag-purple',
  'Espionage': 'tag-purple', 'Taiwan': 'tag-cyan', 'RAT': 'tag-red',
  'Social Engineering': 'tag-amber', 'Red Team Tools': 'tag-amber',
  'EDR Evasion': 'tag-red', 'WFP': 'tag-cyan', 'GPO Abuse': 'tag-amber', 'Safe Mode': 'tag-amber',
};

const gradients = [
  'from-red-500/30 via-orange-500/20 to-yellow-500/10',
  'from-violet-500/30 via-purple-500/20 to-fuchsia-500/10',
  'from-red-600/30 via-rose-500/20 to-pink-500/10',
  'from-blue-500/30 via-indigo-500/20 to-violet-500/10',
  'from-amber-500/30 via-orange-500/20 to-red-500/10',
  'from-emerald-500/30 via-teal-500/20 to-cyan-500/10',
];

// Pick a gradient based on slug hash
const hashCode = entry.id.split('').reduce((acc: number, c: string) => acc + c.charCodeAt(0), 0);
const gradient = gradients[hashCode % gradients.length];

const topicIcons: Record<string, string> = {
  'Ransomware': `<svg class="w-16 h-16" fill="none" stroke="currentColor" stroke-width="0.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/></svg>`,
  'APT': `<svg class="w-16 h-16" fill="none" stroke="currentColor" stroke-width="0.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3"/></svg>`,
  'Red Team Tools': `<svg class="w-16 h-16" fill="none" stroke="currentColor" stroke-width="0.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.249-8.25-3.286zm0 13.036h.008v.008H12v-.008z"/></svg>`,
  'RAT': `<svg class="w-16 h-16" fill="none" stroke="currentColor" stroke-width="0.8" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75c1.148 0 2.278.08 3.383.237 1.037.146 1.866.966 1.866 2.013 0 3.728-2.35 6.75-5.25 6.75S6.75 18.728 6.75 15c0-1.046.83-1.867 1.866-2.013A24.204 24.204 0 0112 12.75z"/></svg>`,
};

const getIcon = (tags: string[]) => {
  for (const tag of tags) {
    if (topicIcons[tag]) return topicIcons[tag];
  }
  return topicIcons['Ransomware'];
};

const isMicrostory = article.type === 'microstory';
const source = article.source || 'Trend AI Research Blog';

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": article.title,
  "description": article.description,
  "datePublished": article.date,
  "author": {
    "@type": "Person",
    "name": "Jacob Santos",
    "jobTitle": "Senior Threat Researcher"
  },
  "publisher": {
    "@type": "Organization",
    "name": source
  },
  "url": `https://jacobsantos.pages.dev/research/${entry.id}`,
  "keywords": article.tags,
};
---

<AppShell
  title={article.title}
  description={article.description}
  jsonLd={jsonLd}
  breadcrumbs={[
    { label: 'Home', href: '/' },
    { label: 'Research', href: '/research' },
    { label: article.title },
  ]}
>
  <!-- Hero header -->
  <div class={`relative rounded-2xl overflow-hidden ${article.image ? '' : `bg-gradient-to-br ${gradient}`} mb-8`}>
    {article.image ? (
      <img src={article.image} alt={article.title} class="absolute inset-0 w-full h-full object-cover" loading="eager" />
      <div class="absolute inset-0 bg-gradient-to-t from-bg-primary/90 via-bg-primary/40 to-transparent"></div>
    ) : (
      <>
        <div class="absolute inset-0" style="background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 24px 24px;"></div>
        <div class="absolute inset-0 flex items-center justify-center text-white/10">
          <Fragment set:html={getIcon(article.tags)} />
        </div>
      </>
    )}
    <div class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-bg-primary to-transparent"></div>

    <div class="relative p-6 md:p-10 pt-16 md:pt-24">
      <!-- Badges -->
      <div class="flex items-center gap-2 mb-4">
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-black/40 backdrop-blur-sm text-[11px] font-mono text-accent-primary border border-accent-primary/20">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
          {source}
        </span>
        <span class="inline-flex items-center px-2.5 py-1 rounded-lg bg-black/40 backdrop-blur-sm text-[11px] font-mono text-text-secondary">
          {article.date}
        </span>
        {isMicrostory && (
          <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-sky-500/20 backdrop-blur-sm text-[11px] font-mono text-sky-300 border border-sky-400/20">
            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            Thread
          </span>
        )}
      </div>

      <h1 class="text-2xl md:text-3xl font-bold text-text-primary tracking-tight leading-tight animate-fade-up">
        {article.title}
      </h1>
    </div>
  </div>

  <!-- Content -->
  <div class="content-card mb-6" data-reveal>
    <!-- Tags -->
    <div class="flex flex-wrap gap-1.5 mb-6">
      {article.tags.map(tag => (
        <span class={tagColors[tag] || 'tag-green'}>{tag}</span>
      ))}
    </div>

    <!-- Description / Summary -->
    <div class="mb-6">
      <p class="text-text-secondary text-sm leading-relaxed">
        {article.summary || article.description}
      </p>
    </div>

    <!-- Divider -->
    <div class="border-t border-white/[0.06] my-6"></div>

    <!-- Action buttons -->
    <div class="flex items-center gap-3">
      <a
        href={article.url}
        target="_blank"
        rel="noopener"
        class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-accent-primary text-bg-primary font-semibold text-sm transition-all hover:shadow-[0_0_30px_-5px_rgba(240,166,58,0.4)] hover:scale-[1.02]"
      >
        {isMicrostory ? (
          <>
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            View Thread
          </>
        ) : (
          <>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
            Read Full Article
          </>
        )}
      </a>
      <a
        href="/research"
        class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl bg-bg-surface border border-white/[0.06] text-text-muted text-sm font-medium hover:text-text-primary hover:border-white/10 transition-all"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Back to Research
      </a>
    </div>
  </div>

  <!-- Related Research -->
  {related.length > 0 && (
    <div class="content-card" data-reveal>
      <div class="flex items-center gap-2 mb-4">
        <svg class="w-4 h-4 text-accent-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m9.86-2.813a4.5 4.5 0 00-6.364-6.364L4.5 8.25a4.5 4.5 0 006.364 6.364l4.5-4.5z"/>
        </svg>
        <h2 class="text-text-primary text-sm font-semibold">Related Research</h2>
      </div>
      <div class="grid sm:grid-cols-2 gap-3">
        {related.map(r => (
          <a
            href={`/research/${r.entry.id}`}
            class="card !p-4 group block"
          >
            <h3 class="text-text-primary text-sm font-medium group-hover:text-accent-primary transition-colors mb-1.5 line-clamp-2">
              {r.entry.data.title}
            </h3>
            <p class="text-text-muted text-xs line-clamp-2 mb-2">{r.entry.data.description}</p>
            <div class="flex flex-wrap gap-1">
              {r.entry.data.tags.slice(0, 2).map(tag => (
                <span class={`${tagColors[tag] || 'tag-green'} !text-[8px]`}>{tag}</span>
              ))}
            </div>
          </a>
        ))}
      </div>
    </div>
  )}
</AppShell>
