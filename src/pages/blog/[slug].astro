---
import AppShell from '../../design-system/components/AppShell.astro';
import Prose from '../../design-system/components/Prose.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  return allPosts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

// Reading time estimate
const words = (post.body || '').split(/\s+/).length;
const readingTime = Math.ceil(words / 200);

const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Build table of contents from headings
const toc = headings.filter(h => h.depth <= 3);

const tagColors: Record<string, string> = {
  'mcp': 'tag-green',
  'ai': 'tag-purple',
  'automation': 'tag-cyan',
  'threat-intelligence': 'tag-red',
  'ransomware': 'tag-red',
  'tools': 'tag-amber',
  'security': 'tag-red',
};

// Related posts (share at least one tag)
const allPosts = await getCollection('blog');
const related = allPosts
  .filter(p => p.slug !== post.slug && !p.data.draft)
  .map(p => {
    const sharedTags = post.data.tags.filter(t => p.data.tags.includes(t));
    return { post: p, sharedCount: sharedTags.length };
  })
  .filter(r => r.sharedCount > 0)
  .sort((a, b) => b.sharedCount - a.sharedCount)
  .slice(0, 3);

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.data.title,
  "description": post.data.excerpt,
  "datePublished": post.data.date,
  "author": {
    "@type": "Person",
    "name": "Jacob Santos",
    "jobTitle": "Senior Threat Researcher",
    "url": "https://jacobsantos.pages.dev"
  },
  "publisher": {
    "@type": "Person",
    "name": "Jacob Santos"
  },
  "url": `https://jacobsantos.pages.dev/blog/${post.slug}`,
  "keywords": post.data.tags,
  "wordCount": words,
};
---

<AppShell
  title={post.data.title}
  description={post.data.excerpt}
  jsonLd={jsonLd}
  breadcrumbs={[
    { label: 'Home', href: '/' },
    { label: 'Blog', href: '/blog' },
    { label: post.data.title },
  ]}
>
  <article>
    <!-- Article header -->
    <div class="content-card mb-6">
      <div class="flex items-center gap-3 text-[11px] font-mono text-text-muted mb-4">
        <time datetime={post.data.date}>{formattedDate}</time>
        <span class="text-text-muted/30">|</span>
        <span>{readingTime} min read</span>
        <span class="text-text-muted/30">|</span>
        <span>{words} words</span>
        {post.data.draft && (
          <>
            <span class="text-text-muted/30">|</span>
            <span class="text-accent-warning">Draft</span>
          </>
        )}
      </div>

      <h1 class="text-2xl md:text-3xl font-bold text-text-primary tracking-tight leading-tight mb-4 animate-fade-up">
        {post.data.title}
      </h1>

      <p class="text-text-secondary text-sm leading-relaxed mb-5">
        {post.data.excerpt}
      </p>

      <div class="flex flex-wrap gap-1.5">
        {post.data.tags.map(tag => (
          <span class={tagColors[tag] || 'tag-green'}>{tag}</span>
        ))}
      </div>
    </div>

    <!-- Table of Contents -->
    {toc.length > 1 && (
      <div class="content-card mb-6" data-reveal>
        <div class="flex items-center gap-2 mb-3">
          <svg class="w-4 h-4 text-accent-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
          </svg>
          <span class="text-text-primary text-xs font-semibold">Table of Contents</span>
        </div>
        <nav aria-label="Table of contents">
          <ul class="space-y-1">
            {toc.map(heading => (
              <li style={`padding-left: ${(heading.depth - 2) * 1}rem`}>
                <a
                  href={`#${heading.slug}`}
                  class="text-text-muted text-xs hover:text-accent-primary transition-colors font-mono block py-0.5"
                >
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </div>
    )}

    <!-- Article content -->
    <div class="content-card mb-6" data-reveal>
      <Prose>
        <Content />
      </Prose>
    </div>

    <!-- Footer navigation -->
    <div class="content-card mb-6">
      <div class="flex items-center justify-between">
        <a
          href="/blog"
          class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl bg-bg-surface border border-white/[0.06] text-text-muted text-sm font-medium hover:text-text-primary hover:border-white/10 transition-all"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
          </svg>
          Back to Blog
        </a>
        <a
          href="/rss.xml"
          class="inline-flex items-center gap-1.5 px-3 py-2 rounded-xl bg-bg-surface border border-white/[0.06] text-text-muted text-xs font-mono hover:text-accent-primary hover:border-accent-primary/10 transition-all"
        >
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m6.75-3v-.75a11.25 11.25 0 00-11.25-11.25H4.5m.75 16.5a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" /></svg>
          RSS
        </a>
      </div>
    </div>

    <!-- Related posts -->
    {related.length > 0 && (
      <div class="content-card" data-reveal>
        <div class="flex items-center gap-2 mb-4">
          <svg class="w-4 h-4 text-accent-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m9.86-2.813a4.5 4.5 0 00-6.364-6.364L4.5 8.25a4.5 4.5 0 006.364 6.364l4.5-4.5z"/>
          </svg>
          <h2 class="text-text-primary text-sm font-semibold">Related Posts</h2>
        </div>
        <div class="space-y-3">
          {related.map(r => {
            const relatedDate = new Date(r.post.data.date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
            });
            return (
              <a href={`/blog/${r.post.slug}`} class="card !p-4 group block">
                <h3 class="text-text-primary text-sm font-medium group-hover:text-accent-primary transition-colors mb-1">
                  {r.post.data.title}
                </h3>
                <p class="text-text-muted text-xs line-clamp-2 mb-2">{r.post.data.excerpt}</p>
                <div class="flex items-center gap-2">
                  <span class="text-text-muted text-[10px] font-mono">{relatedDate}</span>
                  <div class="flex gap-1">
                    {r.post.data.tags.slice(0, 2).map(tag => (
                      <span class={`${tagColors[tag] || 'tag-green'} !text-[8px]`}>{tag}</span>
                    ))}
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </div>
    )}
  </article>
</AppShell>
