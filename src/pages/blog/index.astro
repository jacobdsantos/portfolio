---
import AppShell from '../../design-system/components/AppShell.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');
const posts = allPosts
  .filter(post => import.meta.env.PROD ? !post.data.draft : true)
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// Simple reading time estimate (words / 200 wpm)
const estimateReadingTime = (body: string) => {
  const words = body.split(/\s+/).length;
  const minutes = Math.ceil(words / 200);
  return `${minutes} min read`;
};

const tagColors: Record<string, string> = {
  'mcp': 'tag-green',
  'ai': 'tag-purple',
  'automation': 'tag-cyan',
  'threat-intelligence': 'tag-red',
  'ransomware': 'tag-red',
  'tools': 'tag-amber',
  'security': 'tag-red',
};

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Blog",
  "description": "Threat research, security automation, and cybersecurity insights by Jacob Santos.",
  "url": "https://jacobsantos.pages.dev/blog",
  "author": {
    "@type": "Person",
    "name": "Jacob Santos",
    "jobTitle": "Senior Threat Researcher"
  },
  "numberOfItems": posts.length,
};
---

<AppShell
  title="Blog"
  description="Threat research, security automation, and cybersecurity insights by Jacob Santos."
  jsonLd={jsonLd}
  breadcrumbs={[
    { label: 'Home', href: '/' },
    { label: 'Blog' },
  ]}
>
  <div class="content-card">
    <h1 class="section-title animate-fade-up">Blog</h1>
    <p class="section-subtitle">
      Threat research, security automation, and cybersecurity insights.
      <span class="text-text-muted">Longer-form writing on what I build and what I learn.</span>
    </p>

    <!-- RSS link -->
    <div class="flex items-center gap-2 mb-6">
      <a href="/rss.xml" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-accent-primary/[0.06] border border-accent-primary/10 text-accent-primary text-[11px] font-mono hover:bg-accent-primary/10 transition-all">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m6.75-3v-.75a11.25 11.25 0 00-11.25-11.25H4.5m.75 16.5a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" /></svg>
        RSS Feed
      </a>
      <span class="text-text-muted text-[10px] font-mono">{posts.length} {posts.length === 1 ? 'post' : 'posts'}</span>
    </div>

    {posts.length === 0 ? (
      <div class="text-center py-16">
        <svg class="w-12 h-12 text-text-muted/30 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
        </svg>
        <p class="text-text-muted text-sm">No blog posts yet. Check back soon.</p>
      </div>
    ) : (
      <div class="space-y-4">
        {posts.map(post => {
          const readingTime = estimateReadingTime(post.body || '');
          const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          });
          return (
            <a href={`/blog/${post.slug}`} class="card !p-5 group block">
              <div class="flex items-start justify-between gap-4 mb-2">
                <h2 class="text-text-primary text-base font-semibold group-hover:text-accent-primary transition-colors leading-snug flex-1">
                  {post.data.title}
                  {post.data.featured && (
                    <span class="inline-flex items-center gap-1 ml-2 px-2 py-0.5 rounded-md bg-accent-primary/10 text-accent-primary text-[9px] font-mono border border-accent-primary/20 align-middle">
                      Featured
                    </span>
                  )}
                  {post.data.draft && (
                    <span class="inline-flex items-center gap-1 ml-2 px-2 py-0.5 rounded-md bg-accent-warning/10 text-accent-warning text-[9px] font-mono border border-accent-warning/20 align-middle">
                      Draft
                    </span>
                  )}
                </h2>
                <svg class="w-4 h-4 text-text-muted/40 shrink-0 mt-1 group-hover:text-accent-primary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
              </div>

              <p class="text-text-muted text-xs leading-relaxed mb-3">
                {post.data.excerpt}
              </p>

              <div class="flex items-center justify-between gap-3">
                <div class="flex flex-wrap gap-1">
                  {post.data.tags.slice(0, 4).map(tag => (
                    <span class={`${tagColors[tag] || 'tag-green'} !text-[8px]`}>{tag}</span>
                  ))}
                </div>
                <div class="flex items-center gap-3 text-[10px] font-mono text-text-muted shrink-0">
                  <span>{formattedDate}</span>
                  <span class="text-text-muted/30">|</span>
                  <span>{readingTime}</span>
                </div>
              </div>
            </a>
          );
        })}
      </div>
    )}
  </div>
</AppShell>
